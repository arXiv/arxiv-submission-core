
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>arxiv.submission.services.classic &#8212; arXiv submission &amp; moderation 0.1 documentation</title>
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../../_static/graphviz.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
   
  <link rel="stylesheet" href="../../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for arxiv.submission.services.classic</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Integration with the classic database to persist events and submission state.</span>

<span class="sd">As part of the classic renewal strategy, development of new submission</span>
<span class="sd">interfaces must maintain data interoperability with classic components. This</span>
<span class="sd">service module must therefore do three main things:</span>

<span class="sd">1. Store and provide access to event data generated during the submission</span>
<span class="sd">   process,</span>
<span class="sd">2. Keep the classic database tables up to date so that &quot;downstream&quot; components</span>
<span class="sd">   can continue to operate.</span>
<span class="sd">3. Patch NG submission data with state changes that occur in the classic</span>
<span class="sd">   system. Those changes will be made directly to submission tables and not</span>
<span class="sd">   involve event-generation. See :func:`get_submission` for details.</span>

<span class="sd">Since classic components work directly on submission tables, persisting events</span>
<span class="sd">and resulting submission state must occur in the same transaction. We must also</span>
<span class="sd">verify that we are not storing events that are stale with respect to the</span>
<span class="sd">current state of the submission. To achieve this, the caller should use the</span>
<span class="sd">:func:`.util.transaction` context manager, and (when committing new events)</span>
<span class="sd">call :func:`.get_submission` with ``for_update=True``. This will trigger a</span>
<span class="sd">shared lock on the submission row(s) involved until the transaction is</span>
<span class="sd">committed or rolled back.</span>

<span class="sd">ORM representations of the classic database tables involved in submission</span>
<span class="sd">are located in :mod:`.classic.models`. An additional model, :class:`.DBEvent`,</span>
<span class="sd">is defined in :mod:`.classic.event`.</span>

<span class="sd">See also :ref:`legacy-integration`.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Set</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">retry</span> <span class="k">import</span> <span class="n">retry</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pytz</span> <span class="k">import</span> <span class="n">UTC</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">groupby</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">reduce</span><span class="p">,</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="k">import</span> <span class="n">ior</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="k">import</span> <span class="n">asdict</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">or_</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm.exc</span> <span class="k">import</span> <span class="n">NoResultFound</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.exc</span> <span class="k">import</span> <span class="n">DBAPIError</span><span class="p">,</span> <span class="n">OperationalError</span>

<span class="kn">from</span> <span class="nn">arxiv.base</span> <span class="k">import</span> <span class="n">logging</span>
<span class="kn">from</span> <span class="nn">arxiv.base.globals</span> <span class="k">import</span> <span class="n">get_application_config</span><span class="p">,</span> <span class="n">get_application_global</span>
<span class="kn">from</span> <span class="nn">...domain.event</span> <span class="k">import</span> <span class="n">Event</span><span class="p">,</span> <span class="n">Announce</span><span class="p">,</span> <span class="n">RequestWithdrawal</span><span class="p">,</span> <span class="n">SetDOI</span><span class="p">,</span> \
    <span class="n">SetJournalReference</span><span class="p">,</span> <span class="n">SetReportNumber</span><span class="p">,</span> <span class="n">Rollback</span><span class="p">,</span> <span class="n">RequestCrossList</span><span class="p">,</span> \
    <span class="n">ApplyRequest</span><span class="p">,</span> <span class="n">RejectRequest</span><span class="p">,</span> <span class="n">ApproveRequest</span><span class="p">,</span> <span class="n">AddProposal</span><span class="p">,</span> <span class="n">CancelRequest</span>

<span class="kn">from</span> <span class="nn">...domain.submission</span> <span class="k">import</span> <span class="n">License</span><span class="p">,</span> <span class="n">Submission</span><span class="p">,</span> <span class="n">WithdrawalRequest</span><span class="p">,</span> \
    <span class="n">CrossListClassificationRequest</span>
<span class="kn">from</span> <span class="nn">...domain.agent</span> <span class="k">import</span> <span class="n">Agent</span><span class="p">,</span> <span class="n">User</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="k">import</span> <span class="n">Base</span>
<span class="kn">from</span> <span class="nn">.exceptions</span> <span class="k">import</span> <span class="n">ClassicBaseException</span><span class="p">,</span> <span class="n">NoSuchSubmission</span><span class="p">,</span> \
    <span class="n">TransactionFailed</span><span class="p">,</span> <span class="n">Unavailable</span><span class="p">,</span> <span class="n">ConsistencyError</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="k">import</span> <span class="n">transaction</span><span class="p">,</span> <span class="n">current_session</span><span class="p">,</span> <span class="n">db</span>
<span class="kn">from</span> <span class="nn">.event</span> <span class="k">import</span> <span class="n">DBEvent</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">models</span><span class="p">,</span> <span class="n">util</span><span class="p">,</span> <span class="n">interpolate</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">proposal</span><span class="p">,</span> <span class="n">load</span>


<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">propagate</span> <span class="o">=</span> <span class="kc">False</span>


<div class="viewcode-block" id="handle_operational_errors"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.services.classic.html#arxiv.submission.services.classic.handle_operational_errors">[docs]</a><span class="k">def</span> <span class="nf">handle_operational_errors</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Catch SQLAlchemy OperationalErrors and raise :class:`.Unavailable`.&quot;&quot;&quot;</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">inner</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">OperationalError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Unavailable</span><span class="p">(</span><span class="s1">&#39;Classic database unavailable&#39;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
    <span class="k">return</span> <span class="n">inner</span></div>


<div class="viewcode-block" id="get_licenses"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.services.classic.html#arxiv.submission.services.classic.get_licenses">[docs]</a><span class="nd">@retry</span><span class="p">(</span><span class="n">ClassicBaseException</span><span class="p">,</span> <span class="n">tries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nd">@handle_operational_errors</span>
<span class="k">def</span> <span class="nf">get_licenses</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">License</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;Get a list of :class:`.domain.License` instances available.&quot;&quot;&quot;</span>
    <span class="n">license_data</span> <span class="o">=</span> <span class="n">current_session</span><span class="p">()</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">License</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">License</span><span class="o">.</span><span class="n">active</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">License</span><span class="p">(</span><span class="n">uri</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">row</span><span class="o">.</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">license_data</span><span class="p">]</span></div>


<div class="viewcode-block" id="get_events"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.services.classic.html#arxiv.submission.services.classic.get_events">[docs]</a><span class="nd">@retry</span><span class="p">(</span><span class="n">ClassicBaseException</span><span class="p">,</span> <span class="n">tries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nd">@handle_operational_errors</span>
<span class="k">def</span> <span class="nf">get_events</span><span class="p">(</span><span class="n">submission_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Event</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load events from the classic database.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    submission_id : int</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        Items are :class:`.Event` instances loaded from the class DB.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    :class:`.classic.exceptions.NoSuchSubmission`</span>
<span class="sd">        Raised when there are no events for the provided submission ID.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">current_session</span><span class="p">()</span>
    <span class="n">event_data</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">DBEvent</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">DBEvent</span><span class="o">.</span><span class="n">submission_id</span> <span class="o">==</span> <span class="n">submission_id</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">DBEvent</span><span class="o">.</span><span class="n">created</span><span class="p">)</span>
    <span class="n">events</span> <span class="o">=</span> <span class="p">[</span><span class="n">datum</span><span class="o">.</span><span class="n">to_event</span><span class="p">()</span> <span class="k">for</span> <span class="n">datum</span> <span class="ow">in</span> <span class="n">event_data</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">events</span><span class="p">:</span>      <span class="c1"># No events, no dice.</span>
        <span class="k">raise</span> <span class="n">NoSuchSubmission</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Submission </span><span class="si">{submission_id}</span><span class="s1"> not found&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">events</span></div>


<div class="viewcode-block" id="get_user_submissions_fast"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.services.classic.html#arxiv.submission.services.classic.get_user_submissions_fast">[docs]</a><span class="nd">@retry</span><span class="p">(</span><span class="n">ClassicBaseException</span><span class="p">,</span> <span class="n">tries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nd">@handle_operational_errors</span>
<span class="k">def</span> <span class="nf">get_user_submissions_fast</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Submission</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get all active submissions for a user.</span>

<span class="sd">    Uses the same approach as :func:`get_submission_fast`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    submission_id : int</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list</span>
<span class="sd">        Items are the user&#39;s :class:`.domain.submission.Submission` instances.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">current_session</span><span class="p">()</span>
    <span class="n">db_submissions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="p">)</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">submitter_id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">)</span>
        <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">doc_paper_id</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
    <span class="p">)</span>
    <span class="n">grouped</span> <span class="o">=</span> <span class="n">groupby</span><span class="p">(</span><span class="n">db_submissions</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dbs</span><span class="p">:</span> <span class="n">dbs</span><span class="o">.</span><span class="n">doc_paper_id</span><span class="p">)</span>
    <span class="n">submissions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Submission</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">arxiv_id</span><span class="p">,</span> <span class="n">dbss</span> <span class="ow">in</span> <span class="n">grouped</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Handle group for arXiv ID </span><span class="si">%s</span><span class="s1">: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">arxiv_id</span><span class="p">,</span> <span class="n">dbss</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">arxiv_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>    <span class="c1"># This is an unannounced submission.</span>
            <span class="k">for</span> <span class="n">dbs</span> <span class="ow">in</span> <span class="n">dbss</span><span class="p">:</span>    <span class="c1"># Each row represents a separate e-print.</span>
                <span class="n">submissions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">load</span><span class="o">.</span><span class="n">to_submission</span><span class="p">(</span><span class="n">dbs</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dbss</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">dbss</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">dbs</span><span class="p">:</span> <span class="n">dbs</span><span class="o">.</span><span class="n">submission_id</span><span class="p">)</span>
            <span class="n">submissions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">load</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">dbss</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">submissions</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">s</span><span class="o">.</span><span class="n">deleted</span><span class="p">]</span></div>


<div class="viewcode-block" id="get_submission_fast"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.services.classic.html#arxiv.submission.services.classic.get_submission_fast">[docs]</a><span class="nd">@retry</span><span class="p">(</span><span class="n">ClassicBaseException</span><span class="p">,</span> <span class="n">tries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nd">@handle_operational_errors</span>
<span class="k">def</span> <span class="nf">get_submission_fast</span><span class="p">(</span><span class="n">submission_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Submission</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the projection of the submission directly.</span>

<span class="sd">    Instead of playing events forward, we grab the most recent snapshot of the</span>
<span class="sd">    submission in the database. Since classic represents the submission using</span>
<span class="sd">    several rows, we have to grab all of them and transform/patch as</span>
<span class="sd">    appropriate.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    submission_id : int</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :class:`.domain.submission.Submission`</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    :class:`.classic.exceptions.NoSuchSubmission`</span>
<span class="sd">        Raised when there are is no submission for the provided submission ID.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">load</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">_get_db_submission_rows</span><span class="p">(</span><span class="n">submission_id</span><span class="p">))</span></div>


<span class="c1"># @retry(ClassicBaseException, tries=3, delay=1)</span>
<div class="viewcode-block" id="get_submission"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.services.classic.html#arxiv.submission.services.classic.get_submission">[docs]</a><span class="nd">@handle_operational_errors</span>
<span class="k">def</span> <span class="nf">get_submission</span><span class="p">(</span><span class="n">submission_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">for_update</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> \
        <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Submission</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Event</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the current state of a submission from the database.</span>

<span class="sd">    In the medium term, services that use this package will need to</span>
<span class="sd">    play well with legacy services that integrate with the classic</span>
<span class="sd">    database. For example, the moderation system does not use the event</span>
<span class="sd">    model implemented here, and will therefore cause direct changes to the</span>
<span class="sd">    submission tables that must be reflected in our representation of the</span>
<span class="sd">    submission.</span>

<span class="sd">    Until those legacy components are replaced, this function loads both the</span>
<span class="sd">    event stack and the current DB state of the submission, and uses the DB</span>
<span class="sd">    state to patch fields that may have changed outside the purview of the</span>
<span class="sd">    event model.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    submission_id : int</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    :class:`.domain.submission.Submission`</span>
<span class="sd">    list</span>
<span class="sd">        Items are :class:`Event` instances.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Let the caller determine the transaction scope.</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">current_session</span><span class="p">()</span>
    <span class="n">original_row</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">submission_id</span> <span class="o">==</span> <span class="n">submission_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">for_update</span><span class="p">:</span>
        <span class="c1"># Gives us SELECT ... FOR READ. In other words, lock this row for</span>
        <span class="c1"># writing, but allow other clients to read from it in the meantime.</span>
        <span class="n">original_row</span> <span class="o">=</span> <span class="n">original_row</span><span class="o">.</span><span class="n">with_for_update</span><span class="p">(</span><span class="n">read</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">original_row</span> <span class="o">=</span> <span class="n">original_row</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">NoResultFound</span><span class="p">:</span>       <span class="c1"># May also raise MultipleResultsFound; if so,</span>
                                <span class="c1"># we want to fail loudly.</span>
        <span class="k">raise</span> <span class="n">NoSuchSubmission</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;Submission </span><span class="si">{submission_id}</span><span class="s1"> not found&#39;</span><span class="p">)</span>

    <span class="c1"># Load any subsequent submission rows (e.g. v=2, jref, withdrawal).</span>
    <span class="c1"># These do not have the same legacy submission ID as the original</span>
    <span class="c1"># submission.</span>
    <span class="n">subsequent_rows</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">arxiv_id</span> <span class="o">=</span> <span class="n">original_row</span><span class="o">.</span><span class="n">get_arxiv_id</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">arxiv_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">subsequent_rows</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">doc_paper_id</span> <span class="o">==</span> <span class="n">arxiv_id</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">submission_id</span> <span class="o">!=</span> <span class="n">submission_id</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">submission_id</span><span class="o">.</span><span class="n">asc</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">for_update</span><span class="p">:</span>      <span class="c1"># Lock these rows as well.</span>
            <span class="n">subsequent_rows</span> <span class="o">=</span> <span class="n">subsequent_rows</span><span class="o">.</span><span class="n">with_for_update</span><span class="p">(</span><span class="n">read</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">subsequent_rows</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">subsequent_rows</span><span class="p">)</span>   <span class="c1"># Execute query.</span>

    <span class="n">interpolator</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">ClassicEventInterpolator</span><span class="p">(</span>
        <span class="n">original_row</span><span class="p">,</span>
        <span class="n">subsequent_rows</span><span class="p">,</span>
        <span class="n">get_events</span><span class="p">(</span><span class="n">submission_id</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">interpolator</span><span class="o">.</span><span class="n">get_submission_state</span><span class="p">()</span></div>


<span class="c1"># @retry(ClassicBaseException, tries=3, delay=1)</span>
<div class="viewcode-block" id="store_event"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.services.classic.html#arxiv.submission.services.classic.store_event">[docs]</a><span class="nd">@handle_operational_errors</span>
<span class="k">def</span> <span class="nf">store_event</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">Event</span><span class="p">,</span> <span class="n">before</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Submission</span><span class="p">],</span>
                <span class="n">after</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Submission</span><span class="p">],</span>
                <span class="o">*</span><span class="n">call</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Event</span><span class="p">,</span> <span class="n">Submission</span><span class="p">]:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Store an event, and update submission state.</span>

<span class="sd">    This is where we map the NG event domain onto the classic database. The</span>
<span class="sd">    main differences are that:</span>

<span class="sd">    - In the event domain, a submission is a single stream of events, but</span>
<span class="sd">      in the classic system we create new rows in the submission database</span>
<span class="sd">      for things like replacements, adding DOIs, and withdrawing papers.</span>
<span class="sd">    - In the event domain, the only concept of the announced paper is the</span>
<span class="sd">      paper ID. In the classic submission database, we also have to worry about</span>
<span class="sd">      the row in the Document database.</span>

<span class="sd">    We assume that the submission states passed to this function have the</span>
<span class="sd">    correct paper ID and version number, if announced. The submission ID on</span>
<span class="sd">    the event and the before/after states refer to the original classic</span>
<span class="sd">    submission only.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    event : :class:`Event`</span>
<span class="sd">    before : :class:`Submission`</span>
<span class="sd">        The state of the submission before the event occurred.</span>
<span class="sd">    after : :class:`Submission`</span>
<span class="sd">        The state of the submission after the event occurred.</span>
<span class="sd">    call : list</span>
<span class="sd">        Items are callables that accept args ``Event, Submission, Submission``.</span>
<span class="sd">        These are called within the transaction context; if an exception is</span>
<span class="sd">        raised, the transaction is rolled back.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Let the caller determine the transaction scope.</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">current_session</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">committed</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">TransactionFailed</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> already committed&#39;</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">event_id</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;store event </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">event_type</span><span class="p">)</span>

    <span class="n">doc_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># This is the case that we have a new submission.</span>
    <span class="k">if</span> <span class="n">before</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">after</span><span class="p">,</span> <span class="n">Submission</span><span class="p">):</span>
        <span class="n">dbs</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">NEW_SUBMISSION</span><span class="p">)</span>
        <span class="n">dbs</span><span class="o">.</span><span class="n">update_from_submission</span><span class="p">(</span><span class="n">after</span><span class="p">)</span>
        <span class="n">this_is_a_new_submission</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">else</span><span class="p">:</span>   <span class="c1"># Otherwise we&#39;re making an update for an existing submission.</span>
        <span class="n">this_is_a_new_submission</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># After the original submission is announced, a new Document row is</span>
        <span class="c1"># created. This Document is shared by all subsequent Submission rows.</span>
        <span class="k">if</span> <span class="n">before</span><span class="o">.</span><span class="n">announced</span><span class="p">:</span>
            <span class="n">doc_id</span> <span class="o">=</span> <span class="n">_load_document_id</span><span class="p">(</span><span class="n">before</span><span class="o">.</span><span class="n">arxiv_id</span><span class="p">,</span> <span class="n">before</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>

        <span class="n">JREFEvents</span> <span class="o">=</span> <span class="p">[</span><span class="n">SetDOI</span><span class="p">,</span> <span class="n">SetJournalReference</span><span class="p">,</span> <span class="n">SetReportNumber</span><span class="p">]</span>

        <span class="c1"># From the perspective of the database, a replacement is mainly an</span>
        <span class="c1"># incremented version number. This requires a new row in the</span>
        <span class="c1"># database.</span>
        <span class="k">if</span> <span class="n">after</span><span class="o">.</span><span class="n">version</span> <span class="o">&gt;</span> <span class="n">before</span><span class="o">.</span><span class="n">version</span><span class="p">:</span>
            <span class="n">dbs</span> <span class="o">=</span> <span class="n">_create_replacement</span><span class="p">(</span><span class="n">doc_id</span><span class="p">,</span> <span class="n">before</span><span class="o">.</span><span class="n">arxiv_id</span><span class="p">,</span>
                                      <span class="n">after</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">after</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">created</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">Rollback</span><span class="p">)</span> <span class="ow">and</span> <span class="n">before</span><span class="o">.</span><span class="n">version</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">dbs</span> <span class="o">=</span> <span class="n">_delete_replacement</span><span class="p">(</span><span class="n">doc_id</span><span class="p">,</span> <span class="n">before</span><span class="o">.</span><span class="n">arxiv_id</span><span class="p">,</span>
                                      <span class="n">before</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>

        <span class="c1"># Withdrawals also require a new row, and they use the most recent</span>
        <span class="c1"># version number.</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">RequestWithdrawal</span><span class="p">):</span>
            <span class="n">dbs</span> <span class="o">=</span> <span class="n">_create_withdrawal</span><span class="p">(</span><span class="n">doc_id</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">reason</span><span class="p">,</span>
                                     <span class="n">before</span><span class="o">.</span><span class="n">arxiv_id</span><span class="p">,</span> <span class="n">after</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">after</span><span class="p">,</span>
                                     <span class="n">event</span><span class="o">.</span><span class="n">created</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">RequestCrossList</span><span class="p">):</span>
            <span class="n">dbs</span> <span class="o">=</span> <span class="n">_create_crosslist</span><span class="p">(</span><span class="n">doc_id</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">categories</span><span class="p">,</span>
                                    <span class="n">before</span><span class="o">.</span><span class="n">arxiv_id</span><span class="p">,</span> <span class="n">after</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">after</span><span class="p">,</span>
                                    <span class="n">event</span><span class="o">.</span><span class="n">created</span><span class="p">)</span>

        <span class="c1"># Adding DOIs and citation information (so-called &quot;journal reference&quot;)</span>
        <span class="c1"># also requires a new row. The version number is not incremented.</span>
        <span class="k">elif</span> <span class="n">before</span><span class="o">.</span><span class="n">announced</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="ow">in</span> <span class="n">JREFEvents</span><span class="p">:</span>
            <span class="n">dbs</span> <span class="o">=</span> <span class="n">_create_jref</span><span class="p">(</span><span class="n">doc_id</span><span class="p">,</span> <span class="n">before</span><span class="o">.</span><span class="n">arxiv_id</span><span class="p">,</span> <span class="n">after</span><span class="o">.</span><span class="n">version</span><span class="p">,</span> <span class="n">after</span><span class="p">,</span>
                               <span class="n">event</span><span class="o">.</span><span class="n">created</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">CancelRequest</span><span class="p">):</span>
            <span class="n">dbs</span> <span class="o">=</span> <span class="n">_cancel_request</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="p">)</span>

        <span class="c1"># The submission has been announced.</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">before</span><span class="p">,</span> <span class="n">Submission</span><span class="p">)</span> <span class="ow">and</span> <span class="n">before</span><span class="o">.</span><span class="n">arxiv_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dbs</span> <span class="o">=</span> <span class="n">_load</span><span class="p">(</span><span class="n">paper_id</span><span class="o">=</span><span class="n">before</span><span class="o">.</span><span class="n">arxiv_id</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">before</span><span class="o">.</span><span class="n">version</span><span class="p">)</span>
            <span class="n">_preserve_sticky_hold</span><span class="p">(</span><span class="n">dbs</span><span class="p">,</span> <span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
            <span class="n">dbs</span><span class="o">.</span><span class="n">update_from_submission</span><span class="p">(</span><span class="n">after</span><span class="p">)</span>

        <span class="c1"># The submission has not yet been announced; we&#39;re working with a</span>
        <span class="c1"># single row.</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">before</span><span class="p">,</span> <span class="n">Submission</span><span class="p">)</span> <span class="ow">and</span> <span class="n">before</span><span class="o">.</span><span class="n">submission_id</span><span class="p">:</span>
            <span class="n">dbs</span> <span class="o">=</span> <span class="n">_load</span><span class="p">(</span><span class="n">before</span><span class="o">.</span><span class="n">submission_id</span><span class="p">)</span>

            <span class="n">_preserve_sticky_hold</span><span class="p">(</span><span class="n">dbs</span><span class="p">,</span> <span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="p">,</span> <span class="n">event</span><span class="p">)</span>
            <span class="n">dbs</span><span class="o">.</span><span class="n">update_from_submission</span><span class="p">(</span><span class="n">after</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TransactionFailed</span><span class="p">(</span><span class="s2">&quot;Something is fishy&quot;</span><span class="p">)</span>

    <span class="n">db_event</span> <span class="o">=</span> <span class="n">_new_dbevent</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">dbs</span><span class="p">)</span>
    <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">db_event</span><span class="p">)</span>

    <span class="c1"># Make sure that we get a submission ID; note that this # does not commit</span>
    <span class="c1"># the transaction, just pushes the # SQL that we have generated so far to</span>
    <span class="c1"># the database # server.</span>
    <span class="n">session</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="n">log</span><span class="o">.</span><span class="n">handle</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="p">)</span>   <span class="c1"># Create admin log entry.</span>
    <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">call</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;call </span><span class="si">%s</span><span class="s1"> with event </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">event</span><span class="o">.</span><span class="n">event_id</span><span class="p">)</span>
        <span class="n">func</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">AddProposal</span><span class="p">):</span>
        <span class="n">proposal</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="p">)</span>

    <span class="c1"># Attach the database object for the event to the row for the</span>
    <span class="c1">#  submission.</span>
    <span class="k">if</span> <span class="n">this_is_a_new_submission</span><span class="p">:</span>    <span class="c1"># Update in transaction.</span>
        <span class="n">db_event</span><span class="o">.</span><span class="n">submission</span> <span class="o">=</span> <span class="n">dbs</span>
    <span class="k">else</span><span class="p">:</span>                           <span class="c1"># Just set the ID directly.</span>
        <span class="n">db_event</span><span class="o">.</span><span class="n">submission_id</span> <span class="o">=</span> <span class="n">before</span><span class="o">.</span><span class="n">submission_id</span>

    <span class="n">event</span><span class="o">.</span><span class="n">committed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Update the domain event and submission states with the submission ID.</span>
    <span class="c1"># This should carry forward the original submission ID, even if the</span>
    <span class="c1"># classic database has several rows for the submission (with different</span>
    <span class="c1"># IDs).</span>
    <span class="k">if</span> <span class="n">this_is_a_new_submission</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">submission_id</span> <span class="o">=</span> <span class="n">dbs</span><span class="o">.</span><span class="n">submission_id</span>
        <span class="n">after</span><span class="o">.</span><span class="n">submission_id</span> <span class="o">=</span> <span class="n">dbs</span><span class="o">.</span><span class="n">submission_id</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">event</span><span class="o">.</span><span class="n">submission_id</span> <span class="o">=</span> <span class="n">before</span><span class="o">.</span><span class="n">submission_id</span>
        <span class="n">after</span><span class="o">.</span><span class="n">submission_id</span> <span class="o">=</span> <span class="n">before</span><span class="o">.</span><span class="n">submission_id</span>
    <span class="k">return</span> <span class="n">event</span><span class="p">,</span> <span class="n">after</span></div>


<div class="viewcode-block" id="get_titles"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.services.classic.html#arxiv.submission.services.classic.get_titles">[docs]</a><span class="nd">@retry</span><span class="p">(</span><span class="n">ClassicBaseException</span><span class="p">,</span> <span class="n">tries</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nd">@handle_operational_errors</span>
<span class="k">def</span> <span class="nf">get_titles</span><span class="p">(</span><span class="n">since</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">Agent</span><span class="p">]]:</span>
    <span class="sd">&quot;&quot;&quot;Get titles from submissions created on or after a particular date.&quot;&quot;&quot;</span>
    <span class="c1"># TODO: consider making this a param, if we need this function for anything</span>
    <span class="c1"># else.</span>
    <span class="n">STATUSES_TO_CHECK</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">SUBMITTED</span><span class="p">,</span>
        <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">ON_HOLD</span><span class="p">,</span>
        <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">NEXT_PUBLISH_DAY</span><span class="p">,</span>
        <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">REMOVED</span><span class="p">,</span>
        <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">USER_DELETED</span><span class="p">,</span>
        <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">DELETED_ON_HOLD</span><span class="p">,</span>
        <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">DELETED_PROCESSING</span><span class="p">,</span>
        <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">DELETED_REMOVED</span><span class="p">,</span>
        <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">DELETED_USER_EXPIRED</span>
    <span class="p">]</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">current_session</span><span class="p">()</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
        <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">submission_id</span><span class="p">,</span>
        <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
        <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">submitter_id</span><span class="p">,</span>
        <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">submitter_email</span>
    <span class="p">)</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">STATUSES_TO_CHECK</span><span class="p">))</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">created</span> <span class="o">&gt;=</span> <span class="n">since</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="p">(</span><span class="n">submission_id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">User</span><span class="p">(</span><span class="n">native_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">email</span><span class="o">=</span><span class="n">user_email</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">submission_id</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">user_email</span> <span class="ow">in</span> <span class="n">q</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
    <span class="p">]</span></div>


<span class="c1"># Private functions down here.</span>

<span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="n">submission_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">paper_id</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
          <span class="n">version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">row_type</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> \
        <span class="o">-&gt;</span> <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">row_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">limit_to</span> <span class="o">=</span> <span class="p">[</span><span class="n">row_type</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">limit_to</span> <span class="o">=</span> <span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">NEW_SUBMISSION</span><span class="p">,</span>
                    <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">REPLACEMENT</span><span class="p">]</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">current_session</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">submission_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">submission</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">submission_id</span> <span class="o">==</span> <span class="n">submission_id</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">limit_to</span><span class="p">))</span> \
            <span class="o">.</span><span class="n">one</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">submission_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">paper_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">submission</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">doc_paper_id</span> <span class="o">==</span> <span class="n">paper_id</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">version</span><span class="p">)</span> \
            <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">limit_to</span><span class="p">))</span> \
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">submission_id</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span> \
            <span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">submission</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">submission</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NoSuchSubmission</span><span class="p">(</span><span class="s2">&quot;No submission row matches those parameters&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">submission</span>


<span class="k">def</span> <span class="nf">_cancel_request</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="p">):</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">before</span><span class="o">.</span><span class="n">user_requests</span><span class="p">[</span><span class="n">event</span><span class="o">.</span><span class="n">request_id</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">WithdrawalRequest</span><span class="p">):</span>
        <span class="n">row_type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">WITHDRAWAL</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">CrossListClassificationRequest</span><span class="p">):</span>
        <span class="n">row_type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">CROSS_LIST</span>
    <span class="n">dbs</span> <span class="o">=</span> <span class="n">_load</span><span class="p">(</span><span class="n">paper_id</span><span class="o">=</span><span class="n">before</span><span class="o">.</span><span class="n">arxiv_id</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">before</span><span class="o">.</span><span class="n">version</span><span class="p">,</span>
                <span class="n">row_type</span><span class="o">=</span><span class="n">row_type</span><span class="p">)</span>
    <span class="n">dbs</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">USER_DELETED</span>
    <span class="k">return</span> <span class="n">dbs</span>


<span class="k">def</span> <span class="nf">_load_document_id</span><span class="p">(</span><span class="n">paper_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;get document ID with </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">paper_id</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">current_session</span><span class="p">()</span>
    <span class="n">document_id</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">document_id</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">doc_paper_id</span> <span class="o">==</span> <span class="n">paper_id</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">version</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">document_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NoSuchSubmission</span><span class="p">(</span><span class="s2">&quot;No submission row matches those parameters&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">document_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_create_replacement</span><span class="p">(</span><span class="n">document_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">paper_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                        <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">,</span> <span class="n">created</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> \
        <span class="o">-&gt;</span> <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a new replacement submission.</span>

<span class="sd">    From the perspective of the database, a replacement is mainly an</span>
<span class="sd">    incremented version number. This requires a new row in the database.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dbs</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">REPLACEMENT</span><span class="p">,</span>
                            <span class="n">document_id</span><span class="o">=</span><span class="n">document_id</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">)</span>
    <span class="n">dbs</span><span class="o">.</span><span class="n">update_from_submission</span><span class="p">(</span><span class="n">submission</span><span class="p">)</span>
    <span class="n">dbs</span><span class="o">.</span><span class="n">created</span> <span class="o">=</span> <span class="n">created</span>
    <span class="n">dbs</span><span class="o">.</span><span class="n">updated</span> <span class="o">=</span> <span class="n">created</span>
    <span class="n">dbs</span><span class="o">.</span><span class="n">doc_paper_id</span> <span class="o">=</span> <span class="n">paper_id</span>
    <span class="n">dbs</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">NOT_SUBMITTED</span>
    <span class="k">return</span> <span class="n">dbs</span>


<span class="k">def</span> <span class="nf">_delete_replacement</span><span class="p">(</span><span class="n">document_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">paper_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> \
        <span class="o">-&gt;</span> <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="p">:</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">current_session</span><span class="p">()</span>
    <span class="n">dbs</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">doc_paper_id</span> <span class="o">==</span> <span class="n">paper_id</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">version</span> <span class="o">==</span> <span class="n">version</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">REPLACEMENT</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">submission_id</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span> \
        <span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="n">dbs</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">USER_DELETED</span>
    <span class="k">return</span> <span class="n">dbs</span>


<span class="k">def</span> <span class="nf">_create_withdrawal</span><span class="p">(</span><span class="n">document_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">paper_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                       <span class="n">version</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">,</span>
                       <span class="n">created</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a new withdrawal request.</span>

<span class="sd">    Withdrawals also require a new row, and they use the most recent version</span>
<span class="sd">    number.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dbs</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">WITHDRAWAL</span><span class="p">,</span>
                            <span class="n">document_id</span><span class="o">=</span><span class="n">document_id</span><span class="p">,</span>
                            <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">)</span>
    <span class="n">dbs</span><span class="o">.</span><span class="n">update_withdrawal</span><span class="p">(</span><span class="n">submission</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">paper_id</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">created</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dbs</span>


<span class="k">def</span> <span class="nf">_create_crosslist</span><span class="p">(</span><span class="n">document_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">categories</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">paper_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                      <span class="n">version</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">,</span>
                      <span class="n">created</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a new crosslist request.</span>

<span class="sd">    Cross list requests also require a new row, and they use the most recent</span>
<span class="sd">    version number.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dbs</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">CROSS_LIST</span><span class="p">,</span>
                            <span class="n">document_id</span><span class="o">=</span><span class="n">document_id</span><span class="p">,</span>
                            <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">)</span>
    <span class="n">dbs</span><span class="o">.</span><span class="n">update_cross</span><span class="p">(</span><span class="n">submission</span><span class="p">,</span> <span class="n">categories</span><span class="p">,</span> <span class="n">paper_id</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">created</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dbs</span>


<span class="k">def</span> <span class="nf">_create_jref</span><span class="p">(</span><span class="n">document_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">paper_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">version</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">submission</span><span class="p">:</span> <span class="n">Submission</span><span class="p">,</span>
                 <span class="n">created</span><span class="p">:</span> <span class="n">datetime</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Create a JREF submission.</span>

<span class="sd">    Adding DOIs and citation information (so-called &quot;journal reference&quot;) also</span>
<span class="sd">    requires a new row. The version number is not incremented.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Try to piggy-back on an existing JREF row. In the classic system, all</span>
    <span class="c1"># three fields can get updated on the same row.</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">most_recent_sb</span> <span class="o">=</span> <span class="n">_load</span><span class="p">(</span><span class="n">paper_id</span><span class="o">=</span><span class="n">paper_id</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">,</span>
                               <span class="n">row_type</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">JOURNAL_REFERENCE</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">most_recent_sb</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">most_recent_sb</span><span class="o">.</span><span class="n">is_announced</span><span class="p">():</span>
            <span class="n">most_recent_sb</span><span class="o">.</span><span class="n">update_from_submission</span><span class="p">(</span><span class="n">submission</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">most_recent_sb</span>
    <span class="k">except</span> <span class="n">NoSuchSubmission</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1"># Otherwise, create a new JREF row.</span>
    <span class="n">dbs</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">JOURNAL_REFERENCE</span><span class="p">,</span>
                            <span class="n">document_id</span><span class="o">=</span><span class="n">document_id</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">version</span><span class="p">)</span>
    <span class="n">dbs</span><span class="o">.</span><span class="n">update_from_submission</span><span class="p">(</span><span class="n">submission</span><span class="p">)</span>
    <span class="n">dbs</span><span class="o">.</span><span class="n">created</span> <span class="o">=</span> <span class="n">created</span>
    <span class="n">dbs</span><span class="o">.</span><span class="n">updated</span> <span class="o">=</span> <span class="n">created</span>
    <span class="n">dbs</span><span class="o">.</span><span class="n">doc_paper_id</span> <span class="o">=</span> <span class="n">paper_id</span>
    <span class="n">dbs</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">PROCESSING_SUBMISSION</span>
    <span class="k">return</span> <span class="n">dbs</span>


<span class="k">def</span> <span class="nf">_new_dbevent</span><span class="p">(</span><span class="n">event</span><span class="p">:</span> <span class="n">Event</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DBEvent</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Create an event entry in the database.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">DBEvent</span><span class="p">(</span><span class="n">event_type</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">event_type</span><span class="p">,</span>
                   <span class="n">event_id</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">event_id</span><span class="p">,</span>
                   <span class="n">event_version</span><span class="o">=</span><span class="n">_get_app_version</span><span class="p">(),</span>
                   <span class="n">data</span><span class="o">=</span><span class="n">asdict</span><span class="p">(</span><span class="n">event</span><span class="p">),</span>
                   <span class="n">created</span><span class="o">=</span><span class="n">event</span><span class="o">.</span><span class="n">created</span><span class="p">,</span>
                   <span class="n">creator</span><span class="o">=</span><span class="n">asdict</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">creator</span><span class="p">),</span>
                   <span class="n">proxy</span><span class="o">=</span><span class="n">asdict</span><span class="p">(</span><span class="n">event</span><span class="o">.</span><span class="n">proxy</span><span class="p">)</span> <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">proxy</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_preserve_sticky_hold</span><span class="p">(</span><span class="n">dbs</span><span class="p">:</span> <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="p">,</span> <span class="n">before</span><span class="p">:</span> <span class="n">Submission</span><span class="p">,</span>
                          <span class="n">after</span><span class="p">:</span> <span class="n">Submission</span><span class="p">,</span> <span class="n">event</span><span class="p">:</span> <span class="n">Event</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">dbs</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">ON_HOLD</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="n">dbs</span><span class="o">.</span><span class="n">is_on_hold</span><span class="p">()</span> <span class="ow">and</span> <span class="n">after</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="n">Submission</span><span class="o">.</span><span class="n">WORKING</span><span class="p">:</span>
        <span class="n">dbs</span><span class="o">.</span><span class="n">sticky_status</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">ON_HOLD</span>


<span class="k">def</span> <span class="nf">_get_db_submission_rows</span><span class="p">(</span><span class="n">submission_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="p">]:</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">current_session</span><span class="p">()</span>
    <span class="n">head</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">submission_id</span><span class="p">,</span>
                         <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">doc_paper_id</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">submission_id</span><span class="o">=</span><span class="n">submission_id</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">subquery</span><span class="p">()</span>
    <span class="n">dbss</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="p">)</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">or_</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">submission_id</span> <span class="o">==</span> <span class="n">submission_id</span><span class="p">,</span>
                    <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">doc_paper_id</span> <span class="o">==</span> <span class="n">head</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">doc_paper_id</span><span class="p">))</span>
        <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">submission_id</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dbss</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NoSuchSubmission</span><span class="p">(</span><span class="s1">&#39;No submission found&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dbss</span>


<span class="k">def</span> <span class="nf">_get_app_version</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">get_application_config</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;CORE_VERSION&#39;</span><span class="p">,</span> <span class="s1">&#39;0.0.0&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="init_app"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.services.classic.html#arxiv.submission.services.classic.init_app">[docs]</a><span class="k">def</span> <span class="nf">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="n">Flask</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Register the SQLAlchemy extension to an application.&quot;&quot;&quot;</span>
    <span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>

    <span class="nd">@app</span><span class="o">.</span><span class="n">teardown_request</span>
    <span class="k">def</span> <span class="nf">teardown_request</span><span class="p">(</span><span class="n">exception</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exception</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span></div>


<div class="viewcode-block" id="create_all"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.services.classic.html#arxiv.submission.services.classic.create_all">[docs]</a><span class="k">def</span> <span class="nf">create_all</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Create all tables in the database.&quot;&quot;&quot;</span>
    <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span></div>


<div class="viewcode-block" id="drop_all"><a class="viewcode-back" href="../../../../arxiv.submission/arxiv.submission.services.classic.html#arxiv.submission.services.classic.drop_all">[docs]</a><span class="k">def</span> <span class="nf">drop_all</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Drop all tables in the database.&quot;&quot;&quot;</span>
    <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">drop_all</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">engine</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_get_db_submission_rows</span><span class="p">(</span><span class="n">submission_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="p">]:</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">current_session</span><span class="p">()</span>
    <span class="n">head</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">submission_id</span><span class="p">,</span>
                         <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">doc_paper_id</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">submission_id</span><span class="o">=</span><span class="n">submission_id</span><span class="p">)</span> \
        <span class="o">.</span><span class="n">subquery</span><span class="p">()</span>
    <span class="n">dbss</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
        <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="p">)</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">or_</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">submission_id</span> <span class="o">==</span> <span class="n">submission_id</span><span class="p">,</span>
                    <span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">doc_paper_id</span> <span class="o">==</span> <span class="n">head</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">doc_paper_id</span><span class="p">))</span>
        <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Submission</span><span class="o">.</span><span class="n">submission_id</span><span class="o">.</span><span class="n">desc</span><span class="p">())</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dbss</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">NoSuchSubmission</span><span class="p">(</span><span class="s1">&#39;No submission found&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">dbss</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../../index.html">arXiv submission & moderation</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../architecture.html">Submission &amp; moderation subsystem architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../announcement_process.html">Submission &amp; announcement process</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../submission_api_context.html">Submission API: Context</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../arxiv.submission/arxiv.submission.html">arxiv.submission package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../containers/agent/agent.html">agent package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../containers/metadata/metadata.html">metadata package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../background.html">Background</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  <li><a href="../../submission.html">arxiv.submission</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, arXiv.org.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.0.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>